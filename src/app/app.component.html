<!-- src/app/app.component.html -->
<div class="container">
  <header>
    <h1>{{ appTitle }}</h1>
    <div class="analysis-controls">
      <div class="analysis-options">
        <label>
          <input type="checkbox" [(ngModel)]="showAllDependencies">
          Show All Dependencies (Including Same-Domain)
        </label>
      </div>
      <button (click)="selectAndAnalyzeDirectory()" [disabled]="isLoading">
        {{ isLoading ? 'Analyzing...' : 'Select Directory and Analyze SQL' }}
      </button>
    </div>
  </header>

  <div *ngIf="isLoading || infoMessage" class="status-messages">
    <p *ngIf="isLoading" class="loading">
      <span class="spinner"></span> {{ infoMessage || 'Loading...' }}
    </p>
    <p *ngIf="!isLoading && infoMessage" class="info">{{ infoMessage }}</p>
  </div>

  <div *ngIf="errorMessage" class="status-messages error">
    <p><strong>Error:</strong> {{ errorMessage }}</p>
    <p *ngIf="parsedResult && parsedResult.errors.length > 0">
      See browser console (View > Toggle Developer Tools) for detailed parsing warnings.
    </p>
  </div>

  <div *ngIf="parsedResult && !isLoading" class="results-container">
    <section class="summary">
      <h2>Analysis Summary</h2>
      <p><strong>Selected Root:</strong> {{ selectedDirectoryPath || 'N/A' }}</p>
      <p><strong>Total SQL Procedures Found:</strong> {{ totalProcedures }}</p>
      <p><strong>Cross-Domain Directory Dependencies:</strong> {{ totalDependencies }}</p>
      <p *ngIf="parsedResult.errors.length > 0" class="warning-summary">
        Encountered {{ parsedResult.errors.length }} parsing warnings/errors.
      </p>
    </section>

    <section class="graph-section" *ngIf="graphNodes.length > 0 || graphEdges.length > 0">
      <h3>Dependency Graph</h3>
      <app-graph-visualizer
        [nodesData]="graphNodes"
        [edgesData]="graphEdges"
        [graphTitle]="showAllDependencies ? 'Directory Dependencies (All)' : 'Directory Cross-Domain Dependencies'">
      </app-graph-visualizer>
      
      <div class="legend">
        <div class="legend-item">
          <span class="legend-color" style="background-color: #90EE90;"></span>
          <span>Same-Domain Dependency</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #FF7F50;"></span>
          <span>Cross-Domain Dependency</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #FFFF00;"></span>
          <span>Inbound Dependency (when node selected)</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #FF0000;"></span>
          <span>Outbound Dependency (when node selected)</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background-color: #FFFACD; border: 2px dashed #FF7F50; position: relative;">
            <i class="fas fa-folder-open" style="position: absolute; font-size: 12px; top: 2px; left: 2px; color: #FF7F50;"></i>
          </span>
          <span>Virtual Directory (Referenced but not directly scanned)</span>
        </div>
      </div>
    </section>
    <section class="graph-section" *ngIf="parsedResult && (graphNodes.length === 0 && graphEdges.length === 0) && parsedResult.procedures.size > 0">
        <h3>Dependency Graph</h3>
        <p>No dependencies found to graph. This could be due to:</p>
        <ul>
          <li>No procedure calls detected between directories</li>
          <li>All procedures are in the same directory</li>
          <li>Procedure calls use non-standard patterns that couldn't be detected</li>
        </ul>
        <p>Try to select a higher-level directory containing multiple domain directories, or check your SQL files for proper procedure calls.</p>
    </section>


    <details class="details-section" *ngIf="totalDependencies > 0">
      <summary>Cross-Domain Directory Dependencies List ({{ totalDependencies }})</summary>
      <ul>
        <li *ngFor="let dep of parsedResult!.directoryDependencies">
          <code>{{ dep.sourceDirectory }}</code> â†’ <code>{{ dep.targetDirectory }}</code>
        </li>
      </ul>
    </details>

    <details class="details-section" *ngIf="totalProcedures > 0">
      <summary>Detected Procedures ({{ totalProcedures }})</summary>
      <div class="procedure-list">
        <table>
          <thead>
            <tr>
              <th>Procedure Name (Domain)</th>
              <th>Directory Path</th>
              <th>File Path</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let procEntry of parsedResult!.procedures | keyvalue">
              <td>{{ procEntry.value.name }} ({{ procEntry.value.domain }})</td>
              <td>{{ procEntry.value.directoryPath }}</td>
              <td>{{ procEntry.value.filePath }}</td>
              <td>
                <button class="debug-btn" (click)="debugProcedure(procEntry.value.name)" title="Show procedure calls">
                  Debug Calls
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </details>
    
    <!-- Debug modal for procedure calls -->
    <div *ngIf="debugInfo" class="debug-modal">
      <div class="debug-modal-content">
        <h3>Procedure Call Debug: {{ debugInfo.procedureName }}</h3>
        <div class="debug-info">
          <p *ngIf="debugInfo.calls.length === 0">No calls detected from this procedure.</p>
          <ul *ngIf="debugInfo.calls.length > 0">
            <li *ngFor="let call of debugInfo.calls">{{ call }}</li>
          </ul>
        </div>
        <button class="close-btn" (click)="closeDebug()">Close</button>
      </div>
    </div>
  </div>

  <div *ngIf="!parsedResult && !isLoading && !infoMessage && !errorMessage" class="no-results">
    <p>Click the button above to select a directory and start the analysis.</p>
  </div>
</div>